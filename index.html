<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AETHER CALENDAR | ç·šä¸Šé ç´„ç³»çµ±</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* --- è³ˆä¼¯æ–¯é¢¨æ ¼ï¼šæ¥µç°¡é…è‰²èˆ‡è³ªæ„Ÿ (é è¨­) --- */
:root {
  --bg: #f5f5f7;        /* èƒŒæ™¯è‰² (é¡ Apple æ·ºç°) */
  --card: #ffffff;      /* å¡ç‰‡èƒŒæ™¯ (ç´”ç™½) */
  --primary: #1d1d1f;   /* ä¸»è¦æ–‡å­—/æŒ‰éˆ•é»‘ */
  --accent: #007aff;    /* å¼·èª¿è‰² (Apple ç§‘æŠ€è—) */
  --text: #1d1d1f;      /* å…§æ–‡é¡è‰² */
  --mute: #86868b;      /* æ¬¡è¦æ–‡å­— (æ—¥æœŸã€èªªæ˜) */
  --border: #e5e5ea;    /* é‚Šæ¡†è‰² */
  --disabled: #f2f2f7;  /* ç¦ç”¨/æ·ºç°èƒŒæ™¯ */
  --red: #ff3b30;       /* éŒ¯èª¤è‰² */
  --input-bg: white;    /* è¼¸å…¥æ¡†èƒŒæ™¯ */
  --shadow: 0 10px 30px rgba(0,0,0,0.05); /* å¡ç‰‡é™°å½± */
}

/* --- è—è¡“å®¶æ·±è‰²æ¨¡å¼ (Aether Night) --- */
.dark-mode {
  --bg: #121212;        /* æ¥µè‡´æ·±é»‘èƒŒæ™¯ */
  --card: #1e1e1e;      /* æ·±ç°å¡ç‰‡ */
  --primary: #ffffff;   /* ä¸»è¦æ–‡å­—è®Šç™½ */
  --accent: #0a84ff;    /* æ›´äº®çš„è—è‰²å¼·èª¿ */
  --text: #e5e5ea;      /* æ·ºç°å…§æ–‡ */
  --mute: #999999;      /* æ¬¡è¦æ–‡å­— */
  --border: #333333;    /* é‚Šæ¡†è‰² */
  --disabled: #2d2d2d;  /* ç¦ç”¨/æ·ºç°èƒŒæ™¯ */
  --input-bg: #282828;  /* è¼¸å…¥æ¡†æ·±ç° */
  --shadow: 0 10px 30px rgba(0,0,0,0.3); /* æ·±è‰²é™°å½± */
}

/* é€šç”¨é‡è¨­ */
* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent; 
}

body {
  margin: 0; padding: 20px; 
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", Roboto, "Helvetica Neue", Arial, sans-serif;
  background-color: var(--bg); color: var(--text);
  display: flex; justify-content: center; min-height: 100vh;
  transition: background-color 0.3s, color 0.3s; 
}

.container {
  width: 100%; max-width: 400px; background: var(--card);
  border-radius: 24px; box-shadow: var(--shadow);
  overflow: hidden; height: fit-content; padding-bottom: 20px;
  transition: background 0.3s, box-shadow 0.3s;
}

/* Header çµæ§‹ */
.header { 
    padding: 25px 20px 10px; text-align: center; 
    border-bottom: 1px solid var(--border); 
    display: flex; justify-content: space-between; align-items: center;
}
.header-content { text-align: center; flex-grow: 1; }
.header h2 { margin: 0; font-size: 20px; font-weight: 700; color: var(--primary); transition: color 0.3s;}
.header p { margin: 5px 0 0; font-size: 13px; color: var(--mute); letter-spacing: 0.5px; transition: color 0.3s;}

/* é¢¨æ ¼åˆ‡æ›é–‹é—œ */
.style-toggle-wrapper { width: 40px; display: flex; justify-content: flex-end; }
/* ... (Switch æ¨£å¼ä¸è®Š) ... */
.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input {opacity: 0; width: 0; height: 0;}
.slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background-color: var(--disabled); transition: .4s; border-radius: 34px;
}
.slider:before {
  position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px;
  background-color: white; transition: .4s; border-radius: 50%;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(20px); }

/* --- è¬å¹´æ›†æ ¸å¿ƒæ¨£å¼ --- */
.calendar-wrapper { padding: 20px; }
/* ... (Month Nav æ¨£å¼ä¸è®Š) ... */
.month-nav {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 15px; font-weight: 700; font-size: 18px; color: var(--primary); transition: color 0.3s;
}
.nav-btn {
  width: 36px; height: 36px; border-radius: 50%; background: var(--disabled);
  display: flex; align-items: center; justify-content: center; cursor: pointer;
  font-size: 18px; color: var(--text); transition: 0.3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
}
.nav-btn:hover { 
  background: var(--accent); 
  color: white; 
  box-shadow: 0 2px 5px rgba(0, 122, 255, 0.3); 
} 
.nav-btn:active { transform: scale(0.9); opacity: 0.9; }


.cal-grid {
  display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center;
}
.weekday {
  font-size: 12px; color: var(--mute); padding-bottom: 10px; font-weight: 600; transition: color 0.3s;
}
/* ... (Day Cell æ¨£å¼ä¸è®Š) ... */
.day-cell {
  aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; font-size: 15px; cursor: pointer; transition: 0.2s;
  position: relative; color: var(--text); 
}
.day-cell:hover:not(.empty):not(.past):not(.active) { background: var(--disabled); }
.day-cell.active { 
  background: var(--accent); color: white; font-weight: 700; 
  box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 2px solid var(--primary); 
  transform: scale(1.05); 
}
.day-cell.today { color: var(--accent); font-weight: 700; }
.day-cell.active.today { color: white; border-color: white; } 
.day-cell.past { color: var(--mute); opacity: 0.5; cursor: default; } 
.day-cell.empty { cursor: default; }

/* --- æ™‚æ®µ --- */
.slots-container { padding: 0 20px; border-top: 1px solid var(--border); padding-top: 20px;}
.slots-title { font-size: 13px; font-weight: 600; color: var(--mute); margin-bottom: 15px; display: flex; justify-content: space-between;}
.grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
/* ... (Time Button æ¨£å¼ä¸è®Š) ... */
.time-btn {
  padding: 12px 0; text-align: center; border: 1px solid var(--border);
  border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer;
  transition: 0.2s; background: var(--card); color: var(--text); 
}
.time-btn:hover { border-color: var(--accent); } 
.time-btn.selected { background: var(--accent); color: white; border-color: var(--accent); font-weight: 600; }
.time-btn.disabled { 
  background: var(--disabled); color: var(--mute); cursor: not-allowed; 
  border-color: transparent; text-decoration: line-through; opacity: 0.6;
}

/* --- ğŸŒŸ MODAL è³ªæ„Ÿå¤§å‡ç´š --- */
.modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 99; 
  display: flex; justify-content: center; align-items: flex-end; /* å›ºå®šåœ¨åº•éƒ¨ */
  backdrop-filter: blur(8px); 
  opacity: 0; /* åˆå§‹éš±è— */
  pointer-events: none;
  transition: opacity 0.3s;
}
.modal.show { 
    opacity: 1; 
    pointer-events: auto; 
} 

.modal-content {
  width: 100%; max-width: 400px; background: var(--card); 
  border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 30px;
  box-shadow: 0 -5px 30px rgba(0,0,0,0.1);
  transition: background 0.3s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  transform: translateY(100%); /* è—åœ¨åº•éƒ¨ */
}

/* åº•éƒ¨æ»‘å…¥å‹•ç•« */
.modal.show .modal-content {
    transform: translateY(0);
}

/* ğŸŒŸ æ™‚é–“ç¢ºèªå¡ç‰‡æ¨£å¼ */
.confirm-card {
    background: var(--disabled); 
    padding: 15px; 
    border-radius: 12px; 
    margin-bottom: 25px; 
    font-size: 16px; 
    font-weight: 600; 
    color: var(--primary); 
    text-align: center; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
    transition: background 0.3s, color 0.3s;
}
.confirm-card .time-info {
    font-size: 18px; 
    font-weight: 800; /* åŠ ç²— */
    color: var(--accent); /* å¼·èª¿è‰² */
}

/* ğŸŒŸ å¿…å¡«æ¬„ä½è¦–è¦ºåˆ†å±¤ */
.form-group { margin-bottom: 20px; }
.required-group {
    background: var(--disabled); 
    padding: 15px; 
    border-radius: 12px;
    margin-bottom: 25px; 
}
.required-group .form-label {
    color: var(--accent) !important; 
    font-weight: 700 !important; 
    font-size: 14px !important; 
}

.form-input, .form-select, .form-textarea { 
  width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px;
  font-size: 16px; outline: none; transition: 0.2s;
  background-color: var(--input-bg); color: var(--text);
  margin-top: 5px; 
}
.form-select { 
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2386868b' d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 30px;
}
.form-input:focus, .form-select:focus, .form-textarea:focus { 
  border-color: var(--accent); 
  box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); 
}
.form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: var(--text); }
.submit-btn {
  width: 100%; padding: 15px; background: var(--accent); 
  color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600;
  cursor: pointer; transition: 0.2s; position: relative;
  overflow: hidden; /* for spinner */
  box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4); /* æŒ‰éˆ•é™°å½± */
}
.submit-btn:active:not(.loading) {
    background: #006dd9; /* é»æ“Šæ™‚é¡è‰²è®Šæ·± */
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.4);
    transform: translateY(1px);
}

/* è¼‰å…¥ spinner æ¨£å¼ */
.submit-btn.loading span { opacity: 0; }
.submit-btn .loading-spinner {
    position: absolute; top: 50%; left: 50%; 
    transform: translate(-50%, -50%);
    width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite;
    display: none;
}
.submit-btn.loading .loading-spinner { display: block; }
@keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

/* Toast æ¨£å¼ */
#toast-msg {
    position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background: #333; color: white; padding: 10px 20px; border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s; z-index: 100; font-size: 14px;
}
#toast-msg.show { opacity: 1; visibility: visible; }
#toast-msg.success { background: #4CAF50; }
#toast-msg.error { background: var(--red); }

</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="style-toggle-wrapper">
        <label class="switch">
            <input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()">
            <span class="slider"></span>
        </label>
    </div>
    <div class="header-content">
        <h2>ç·šä¸Šé ç´„ç³»çµ±</h2>
        <p>AETHER BOOKING SERVICE</p>
    </div>
    <div class="style-toggle-wrapper">
        </div>
  </div>

  <div class="calendar-wrapper">
    <div class="month-nav">
      <div class="nav-btn" onclick="changeMonth(-1)">&#8249;</div>
      <div id="currentMonthYear">YYYY å¹´ MM æœˆ</div>
      <div class="nav-btn" onclick="changeMonth(1)">&#8250;</div>
    </div>
    
    <div class="cal-grid">
      <div class="weekday">æ—¥</div><div class="weekday">ä¸€</div><div class="weekday">äºŒ</div>
      <div class="weekday">ä¸‰</div><div class="weekday">å››</div><div class="weekday">äº”</div><div class="weekday">å…­</div>
    </div>
    <div class="cal-grid" id="dayGrid">
      </div>
  </div>

  <div class="slots-container">
    <div class="slots-title">
      <span>é¸æ“‡æ™‚æ®µ</span>
      <span id="selectedDateLabel" style="color:var(--accent);">è«‹é¸æ“‡æ—¥æœŸ</span>
    </div>
    <div class="grid" id="slotsGrid">
      <div style="grid-column:1/-1; text-align:center; color:#999; font-size:12px; padding:20px;">
        ğŸ‘‡ é»æ“Šä¸Šæ–¹æ—¥æ›†æŸ¥çœ‹
      </div>
    </div>
  </div>
</div>

<div class="modal" id="bookingModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h3 style="margin:0; font-size:20px; font-weight:700;">ç¢ºèªé ç´„è³‡è¨Š</h3>
      <span onclick="closeModal()" style="cursor:pointer; font-size:24px; color:var(--mute);">âœ•</span>
    </div>
    
    <div class="confirm-card">
        é ç´„æ—¥æœŸï¼š<span class="time-info" id="confirmDate"></span> 
        <br>
        é ç´„æ™‚é–“ï¼š<span class="time-info" id="confirmTime"></span>
    </div>

    <div class="form-group required-group">
        <label class="form-label" for="uFormality">âœ… é ç´„é¢¨æ ¼ (å¿…å¡«)</label>
        <select class="form-select" id="uFormality" required>
          <option value="">è«‹é¸æ“‡æœƒé¢é¢¨æ ¼</option>
          <option value="QuickConsult">å¿«é€Ÿè«®è©¢ (15 mins)</option>
          <option value="DeepDive">æ·±åº¦æœƒè«‡ (30 mins)</option>
          <option value="CasualChat">éš¨æ„èŠèŠ (ç„¡å£“åŠ›)</option>
          <option value="Uncategorized">å…¶ä»–/å¾…å®š</option>
        </select>
        
        <label class="form-label" for="uName">æ‚¨çš„å§“å (å¿…å¡«)</label>
        <input type="text" class="form-input" id="uName" placeholder="è«‹è¼¸å…¥å§“å" required>
        
        <label class="form-label" for="uEmail">é›»å­éƒµä»¶ (å¿…å¡«ï¼Œç”¨æ–¼ç™¼é€é‚€è«‹)</label>
        <input type="email" class="form-input" id="uEmail" placeholder="name@example.com" required>
    </div>

    <div class="form-group">
        <label class="form-label" style="font-size: 14px; font-weight: 700; color: var(--mute);">é¸å¡«ï¼šå½ˆæ€§èˆ‡å‚™è¨»è³‡è¨Š</label>
        <label class="form-label" for="uPhone">æ‰‹æ©Ÿè™Ÿç¢¼ (é¸å¡«ï¼Œåƒ…ä¾›ç·Šæ€¥è¯çµ¡)</label>
        <input type="tel" class="form-input" id="uPhone" placeholder="09xx-xxx-xxx (é¸å¡«)">

        <label class="form-label" for="uNotes">éœ€æ±‚ç°¡è¿° (é¸å¡«)</label>
        <textarea class="form-input form-textarea" id="uNotes" placeholder="æ‚¨å¸Œæœ›é€™æ¬¡æœƒé¢ä¸»è¦è¨è«–çš„å…§å®¹ï¼Ÿ(é¸å¡«)" rows="2"></textarea>
    </div>

    <button class="submit-btn" id="btnSubmit" onclick="submitData()">
      <span>å®Œæˆé ç´„ (é‚€è«‹å‡½å°‡ç™¼é€è‡³ Email)</span>
      <div class="loading-spinner"></div>
    </button>
  </div>
</div>

<div id="toast-msg"></div>


<script>
  // ğŸ”´ ğŸ”´ ğŸ”´ å‹™å¿…å¡«å…¥æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€ ğŸ”´ ğŸ”´ ğŸ”´
  const API_ENDPOINT = "https://script.google.com/macros/s/AKfycby-FO85yH9fFSP7W_JHc4YB857m1UyOkwDonHhGnqUTXDB4YAl3URzDqnGdtvGyKOsv/exec"; 

  const TIME_SLOTS = ["10:00", "11:00", "12:00", "14:00", "15:00", "16:00", "17:00", "18:00", "19:00"];
  
  let state = {
    currentYear: new Date().getFullYear(),
    currentMonth: new Date().getMonth(), // 0-11
    selectedDate: null,
    selectedTime: null
  };

  // --- é¢¨æ ¼åˆ‡æ›åŠŸèƒ½ ---
  function toggleDarkMode() {
      const body = document.body;
      const toggle = document.getElementById('darkModeToggle');
      
      if (toggle.checked) {
          body.classList.add('dark-mode');
          localStorage.setItem('theme', 'dark');
      } else {
          body.classList.remove('dark-mode');
          localStorage.setItem('theme', 'light');
      }
  }

  // æª¢æŸ¥ç”¨æˆ¶ä¸Šæ¬¡çš„åå¥½ï¼Œåˆå§‹åŒ–é¢¨æ ¼
  (function initTheme() {
      if (localStorage.getItem('theme') === 'dark') {
          document.body.classList.add('dark-mode');
          const toggle = document.getElementById('darkModeToggle');
          if(toggle) toggle.checked = true;
      }
  })();
  // -------------------------


  // --- Toast é€šçŸ¥åŠŸèƒ½ ---
  function showToast(message, type = 'success') {
      const toast = document.getElementById('toast-msg');
      toast.innerText = message;
      toast.className = ''; 
      toast.classList.add(type, 'show');

      // éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºä¹…ä¸€é» (6ç§’)ï¼Œä¸€èˆ¬è¨Šæ¯ (3.5ç§’)
      const duration = type === 'error' ? 6000 : 3500;

      setTimeout(() => {
          toast.classList.remove('show');
      }, duration); 
  }
  // ----------------------------------------

  // 1. åˆå§‹åŒ–èˆ‡æ¸²æŸ“æ—¥æ›†
  function initCalendar() {
    renderCalendar(state.currentYear, state.currentMonth);
  }

  function changeMonth(delta) {
    state.currentMonth += delta;
    if (state.currentMonth > 11) {
      state.currentMonth = 0;
      state.currentYear++;
    } else if (state.currentMonth < 0) {
      state.currentMonth = 11;
      state.currentYear--;
    }
    
    const today = new Date();
    today.setDate(1); // æ¯”è¼ƒæœˆä»½æ™‚è¨­ç‚º 1 è™Ÿ
    
    const currentViewDate = new Date(state.currentYear, state.currentMonth, 1);
    
    // æª¢æŸ¥æ˜¯å¦è©¦åœ–æŸ¥çœ‹éå»çš„æœˆä»½
    if (currentViewDate.getFullYear() < today.getFullYear() || 
        (currentViewDate.getFullYear() === today.getFullYear() && currentViewDate.getMonth() < today.getMonth())) {
        
        state.currentYear = today.getFullYear();
        state.currentMonth = today.getMonth();
        showToast("ä¸èƒ½æŸ¥çœ‹éå»çš„æœˆä»½ã€‚", 'error');
    }

    renderCalendar(state.currentYear, state.currentMonth);
  }

  function renderCalendar(year, month) {
    const grid = document.getElementById('dayGrid');
    const title = document.getElementById('currentMonthYear');
    grid.innerHTML = "";
    title.innerText = `${year} å¹´ ${month + 1} æœˆ`;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const today = new Date();
    today.setHours(0,0,0,0); 

    const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

    for(let i=0; i<firstDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'day-cell empty';
      grid.appendChild(empty);
    }

    for(let day=1; day<=daysInMonth; day++) {
      const cell = document.createElement('div');
      cell.className = 'day-cell';
      cell.innerText = day;
      
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      
      const cellDate = new Date(year, month, day);
      cellDate.setHours(0,0,0,0); // ç¢ºä¿æ™‚å€ä¸€è‡´æ€§

      if(dateStr === todayStr) cell.classList.add('today');
      
      // åˆ¤æ–·æ˜¯å¦ç‚ºéå»æ—¥æœŸï¼šå¦‚æœæ—¥æœŸæ—©æ–¼ä»Šå¤©
      if(cellDate < today) {
        cell.classList.add('past');
      } else {
        cell.onclick = () => {
          document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('active'));
          cell.classList.add('active');
          fetchSlots(dateStr);
        };
      }
      
      if(dateStr === state.selectedDate) cell.classList.add('active');

      grid.appendChild(cell);
    }
  }

  // 2. è®€å–å¾Œç«¯
  async function fetchSlots(dateStr) {
    state.selectedDate = dateStr;
    state.selectedTime = null; 
    document.getElementById('selectedDateLabel').innerText = dateStr;
    
    const grid = document.getElementById('slotsGrid');
    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#999; font-size:12px; padding:20px;">â˜ï¸ æ­£åœ¨æŸ¥è©¢é›²ç«¯æ™‚æ®µ...</div>';

    try {
      const res = await fetch(`${API_ENDPOINT}?action=get_booked&date=${dateStr}`);
      const data = await res.json();
      
      if(data.status === 'success') {
        renderSlots(data.booked);
      } else {
        console.error("GAS Error:", data);
        showToast("éŒ¯èª¤ï¼šç„¡æ³•å–å¾—æ™‚æ®µè³‡æ–™ã€‚è«‹æª¢æŸ¥ GAS å¾Œç«¯é…ç½®ã€‚", 'error');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:var(--red);">ç³»çµ±éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡</div>';
      }
    } catch(e) {
      console.error(e);
      showToast("é€£ç·šéŒ¯èª¤ï¼šè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯æˆ– GAS éƒ¨ç½²ç‹€æ…‹ã€‚", 'error');
      grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:var(--red);">ç„¡æ³•é€£ç·šè‡³é ç´„æœå‹™</div>';
    }
  }

  function renderSlots(bookedArr) {
    const grid = document.getElementById('slotsGrid');
    grid.innerHTML = "";

    // æç¤ºæ‰€æœ‰æ™‚æ®µçš†å¯é ç´„
    if(!bookedArr || bookedArr.length === 0) {
        showToast("è©²æ—¥æ‰€æœ‰æ™‚æ®µçš†å¯é ç´„ï¼", 'success');
    }

    TIME_SLOTS.forEach(time => {
      const btn = document.createElement('div');
      btn.className = 'time-btn';
      btn.innerText = time;

      if(bookedArr && bookedArr.includes(time)) {
        btn.classList.add('disabled');
      } else {
        btn.onclick = () => {
          document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          state.selectedTime = time;
          openModal();
        };
      }
      grid.appendChild(btn);
    });
  }

  // 3. é€å‡ºé ç´„
  async function submitData() {
    // ç²å–æ‰€æœ‰è¡¨å–®å€¼
    const name = document.getElementById('uName').value.trim();
    const email = document.getElementById('uEmail').value.trim(); 
    const formality = document.getElementById('uFormality').value.trim(); 
    const phone = document.getElementById('uPhone').value.trim();
    const notes = document.getElementById('uNotes').value.trim();

    const btn = document.getElementById('btnSubmit');

    // å¿…å¡«æ¬„ä½æª¢æŸ¥
    if(!name || !email || !formality || formality === "") {
        showToast("è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼šé¢¨æ ¼ã€å§“åã€é›»å­éƒµä»¶ã€‚", 'error');
        if (formality === "") document.getElementById('uFormality').focus();
        else if (!name) document.getElementById('uName').focus();
        else if (!email) document.getElementById('uEmail').focus();
        return;
    }
    
    // ç°¡å–® Email æ ¼å¼æª¢æŸ¥
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showToast("è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€ã€‚", 'error');
        document.getElementById('uEmail').focus();
        return;
    }

    btn.classList.add('loading');
    btn.disabled = true;

    const payload = {
        date: state.selectedDate,
        time: state.selectedTime,
        name: name,
        email: email, 
        formality: formality, 
        phone: phone, 
        notes: notes, 
        action: 'submit_booking'
    };

    try {
        const res = await fetch(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'text/plain' }
        });
        
        const result = await res.json();
        
        if(result.status === 'success') {
            // ä½¿ç”¨å¾Œç«¯è¿”å›çš„ msgï¼Œé€™å€‹ msg å·²ç¶“è™•ç†äº† Email æˆåŠŸ/å¤±æ•—çš„å…©ç¨®æƒ…æ³
            showToast("âœ… " + result.msg, 'success'); 
            closeModal();
            fetchSlots(state.selectedDate); 
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('uName').value = "";
            document.getElementById('uEmail').value = "";
            document.getElementById('uPhone').value = "";
            document.getElementById('uNotes').value = "";
            document.getElementById('uFormality').value = "";
        } else {
            // é€™æ˜¯è³‡æ–™å¯«å…¥å¤±æ•—æˆ–æ™‚æ®µè¢«æ¶çš„éŒ¯èª¤
            showToast("âš ï¸ é ç´„å¤±æ•—ï¼" + result.msg, 'error');
            closeModal();
            fetchSlots(state.selectedDate); 
        }

    } catch(e) {
        console.error("é€£ç·šéŒ¯èª¤:", e);
        // é€™æ‡‰ç‚ºç¶²è·¯æ•…éšœæˆ– GAS éƒ¨ç½²å¤§å•é¡Œ
        showToast("âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤ï¼šç„¡æ³•èˆ‡ä¼ºæœå™¨é€šä¿¡ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œé‡è©¦ã€‚", 'error'); 
        closeModal();
        fetchSlots(state.selectedDate);
    }

    btn.classList.remove('loading');
    btn.disabled = false;
  }

  function openModal() {
    if (!state.selectedDate || !state.selectedTime) {
        return showToast("è«‹å…ˆé¸æ“‡æ—¥æœŸå’Œæ™‚æ®µã€‚", 'error');
    }
    document.getElementById('confirmDate').innerText = state.selectedDate;
    document.getElementById('confirmTime').innerText = state.selectedTime;
    document.getElementById('bookingModal').classList.add('show');
    document.getElementById('uFormality').focus();
  }
  
  function closeModal() {
    document.getElementById('bookingModal').classList.remove('show');
    document.querySelectorAll('.time-btn.selected').forEach(b => b.classList.remove('selected'));
    state.selectedTime = null;
  }

  initCalendar();

</script>
</body>
</html>